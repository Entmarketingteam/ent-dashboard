# ENT Agency Creator Dashboard

## Your Job
Build and ship a production Next.js dashboard that pulls LTK creator analytics. Handle token rotation automatically. Deploy to Vercel. Do not stop until `npm run build` passes clean and the dashboard renders.

## BEFORE WRITING ANY CODE — Read These Docs
Read every file in `docs/` in this order. They contain API specs, auth flows, Airtable schemas, and architecture diagrams you will need. Do not skip this.
1. `docs/LTK_AUTH.md` — Token rotation (the hard part)
2. `docs/LTK_API.md` — Verified endpoints
3. `docs/ARCHITECTURE.md` — System design
4. `docs/AIRTABLE_SCHEMA.md` — Token storage
5. `docs/CREATORS.md` — Creator accounts

## BEFORE WRITING ANY CODE — Run Preflight
Run `scripts/preflight.sh` FIRST. It checks:
- Whether .env.local exists and has the Airtable key
- Whether Airtable is reachable and has the right table/fields
- Whether a valid LTK refresh token exists in Airtable
- Whether missing Airtable fields need to be created

If preflight fails, it prints EXACTLY what the human needs to do — one specific action, not a list. Fix what you can programmatically (create missing fields, fix table structure). Only halt and print human instructions for things that truly require a human (getting an Airtable API key, re-authenticating to LTK).

If preflight passes, proceed directly to build.

## Tech Stack
- Next.js 14+ (App Router, `src/` directory)
- TypeScript (strict, no `any`)
- Tailwind CSS + shadcn/ui
- Recharts for charts
- axios for HTTP
- Airtable SDK for token storage
- Deployed to Vercel with cron jobs

## Project Structure
```
src/
├── app/
│   ├── layout.tsx
│   ├── page.tsx                          # Home — all creators overview
│   ├── creator/[slug]/page.tsx           # Creator detail with charts
│   ├── settings/page.tsx                 # Token health + reconnect instructions
│   └── api/
│       ├── ltk/
│       │   ├── [creatorSlug]/
│       │   │   ├── overview/route.ts     # Summary metrics
│       │   │   ├── hero-chart/route.ts   # Daily performance
│       │   │   ├── earnings/route.ts     # Commission data
│       │   │   ├── engagement/route.ts   # Clicks, orders, revenue
│       │   │   └── top-products/route.ts # Best performers
│       │   ├── refresh/route.ts          # Force token refresh
│       │   └── sync/route.ts             # Full data sync
│       ├── cron/
│       │   ├── refresh-tokens/route.ts   # Every 45 min
│       │   └── sync-analytics/route.ts   # Every 4 hours
│       ├── connect/ltk/route.ts          # Bookmarklet token receiver
│       └── health/route.ts               # All creators token status
├── lib/
│   ├── ltk/
│   │   ├── token-manager.ts              # Mutex + Airtable persistence
│   │   ├── api-client.ts                 # axios with auto-refresh interceptor
│   │   ├── endpoints.ts                  # Endpoint URL builders
│   │   └── types.ts                      # API response types
│   ├── airtable/
│   │   ├── client.ts                     # SDK init
│   │   └── tokens.ts                     # CRUD for token records
│   ├── cache.ts                          # In-memory + optional Vercel KV
│   └── errors.ts                         # Error types, classification, alerting
├── components/
│   ├── dashboard/
│   │   ├── creator-card.tsx
│   │   ├── revenue-chart.tsx
│   │   ├── engagement-chart.tsx
│   │   ├── top-products-table.tsx
│   │   └── token-status-badge.tsx
│   └── layout/
│       ├── sidebar.tsx
│       └── creator-switcher.tsx
└── types/
    └── index.ts
```

## Environment Variables
```env
AIRTABLE_API_KEY=        # Human must provide (Airtable personal access token)
AIRTABLE_BASE_ID=appQnKyfyRyhHX44h
LTK_AUTH_URL=https://creator-auth.shopltk.com/oauth/token
LTK_CLIENT_ID=iKyQz7GfBMBPqUqCbbKSNBUlM2VpNWUT
LTK_API_GATEWAY=https://api-gateway.rewardstyle.com
LTK_CREATOR_API=https://creator-api-gateway.shopltk.com/v1
CRON_SECRET=             # Auto-generated by preflight if missing
```

## Build Sequence
1. Run `scripts/preflight.sh` — halt if it fails, proceed if it passes
2. Initialize Next.js (if no package.json): `npx create-next-app@latest . --typescript --tailwind --app --src-dir --import-alias "@/*" --yes`
3. Install deps: `npm install axios airtable recharts date-fns`
4. Init shadcn: `npx shadcn@latest init -y -d` then `npx shadcn@latest add card button badge table tabs skeleton toast alert separator avatar dropdown-menu`
5. Build `src/lib/airtable/` — test connection by reading Nicki's record
6. Build `src/lib/ltk/token-manager.ts` — test by calling `getValidToken("nicki")`
7. Build `src/lib/ltk/api-client.ts` — test by fetching `/api/health`
8. Build all `/api/` route handlers
9. Build components
10. Build pages
11. Build cron routes + `vercel.json`
12. `npm run build` — loop and fix until zero errors
13. `npm run dev` — verify dashboard loads, test routes with curl

## Self-Healing Rules
- If `npm run build` has TypeScript errors → fix them and rebuild
- If a dependency is missing → install it and rebuild
- If shadcn components fail to install → try individual installs, then fallback to manual component files
- If Airtable read fails → check if AIRTABLE_API_KEY is set, check if table name matches
- If LTK API returns 401 → trigger token refresh through TokenManager
- If LTK refresh returns `invalid_grant` → mark creator as `needs_reauth` in Airtable, continue building other parts
- If any API endpoint structure doesn't match docs → check both API gateway URLs, try alternate endpoint
- NEVER hardcode tokens in source code
- NEVER skip the mutex pattern in TokenManager
- NEVER make LTK API calls from client-side components
- All LTK data flows through `/api/` server routes only

## Validation Checklist (must all pass before stopping)
- [ ] `npm run build` exits 0
- [ ] `npm run dev` starts without errors
- [ ] `curl localhost:3000/api/health` returns JSON with creator status
- [ ] Dashboard home page renders with creator cards (even if showing "no data" for creators without valid tokens)
- [ ] `/creator/nicki` page renders with chart placeholders
- [ ] `/settings` page shows token status and bookmarklet instructions
- [ ] `vercel.json` exists with cron configuration
